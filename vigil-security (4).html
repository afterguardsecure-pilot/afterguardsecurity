<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AfterGuard â€” Security Overview</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--slate-950:#0a0c0f;--slate-900:#0f1318;--slate-800:#171d26;--slate-700:#1f2937;--slate-600:#374151;--slate-400:#9ca3af;--slate-300:#d1d5db;--slate-200:#e5e7eb;--gold-400:#d4a853;--gold-300:#e2bb72;--gold-200:#f0d4a0;--gold-500:#b8922e;--sage:#7a9e8e;--sage-light:#a3c4b5;--danger:#c0392b;--warn:#d97706;--ok:#2d6a4f;}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--slate-950);color:var(--slate-300);font-family:'Cormorant Garamond',Georgia,serif;min-height:100vh;overflow-x:hidden;}

/* SIDEBAR */
.sidebar{position:fixed;left:0;top:0;bottom:0;width:240px;background:var(--slate-900);border-right:1px solid rgba(212,168,83,0.12);display:flex;flex-direction:column;z-index:100;}
.logo{padding:28px 24px 24px;border-bottom:1px solid rgba(212,168,83,0.1);}
.logo-mark{display:flex;align-items:center;gap:12px;margin-bottom:6px;}
.logo-shield{width:32px;height:32px;background:rgba(212,168,83,0.1);border:1px solid rgba(212,168,83,0.25);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.logo-name{font-size:16px;font-weight:300;letter-spacing:0.12em;color:var(--gold-300);font-family:'Cormorant Garamond',serif;}
.logo-tagline{font-size:10px;letter-spacing:0.2em;color:var(--slate-400);font-family:'DM Mono',monospace;text-transform:uppercase;margin-left:44px;}
.nav{flex:1;padding:20px 0;overflow-y:auto;}
.nav-section-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.25em;text-transform:uppercase;color:var(--slate-600);padding:0 24px;margin-bottom:8px;margin-top:16px;}
.nav-item{display:flex;align-items:center;gap:12px;padding:10px 24px;transition:all 0.2s;font-size:15px;color:var(--slate-400);border-left:2px solid transparent;text-decoration:none;}
.nav-item:hover{color:var(--slate-200);background:rgba(212,168,83,0.04);}
.nav-item.active{color:var(--gold-300);border-left-color:var(--gold-400);background:rgba(212,168,83,0.06);}
.nav-icon{font-size:15px;width:18px;text-align:center;flex-shrink:0;opacity:0.7;}
.nav-item.active .nav-icon{opacity:1;}
.sidebar-footer{padding:16px 24px;border-top:1px solid rgba(212,168,83,0.08);}
.user-card{display:flex;align-items:center;gap:10px;}
.user-avatar{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--gold-500),var(--sage));display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--slate-950);font-weight:700;flex-shrink:0;letter-spacing:0;}
.user-info{flex:1;min-width:0;}
.user-name{font-size:14px;color:var(--slate-200);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:'Cormorant Garamond',serif;}
.user-role{font-size:10px;font-family:'DM Mono',monospace;color:var(--gold-400);letter-spacing:0.1em;text-transform:uppercase;margin-top:2px;}
.signout-btn{margin-top:10px;width:100%;background:transparent;border:1px solid rgba(212,168,83,0.12);border-radius:3px;color:var(--slate-400);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.12em;text-transform:uppercase;padding:7px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:6px;}
.signout-btn:hover{border-color:rgba(212,168,83,0.3);color:var(--gold-300);}

/* MAIN */
.main{margin-left:240px;min-height:100vh;display:flex;flex-direction:column;}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:20px 36px;border-bottom:1px solid rgba(212,168,83,0.08);background:var(--slate-950);position:sticky;top:0;z-index:50;backdrop-filter:blur(12px);}
.page-eyebrow{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.2em;text-transform:uppercase;color:var(--gold-400);margin-bottom:2px;}
.page-title{font-size:26px;font-weight:300;color:var(--slate-200);font-family:'Cormorant Garamond',serif;}
.topbar-right{display:flex;align-items:center;gap:12px;}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--sage-light);box-shadow:0 0 6px var(--sage-light);animation:pgreen 2s ease-in-out infinite;}
@keyframes pgreen{0%,100%{box-shadow:0 0 5px var(--sage-light)}50%{box-shadow:0 0 14px var(--sage-light)}}
.live-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--slate-600);letter-spacing:0.12em;}

/* BTN */
.btn{display:inline-flex;align-items:center;gap:7px;padding:8px 18px;border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.08em;cursor:pointer;transition:all 0.2s;border:none;text-decoration:none;white-space:nowrap;}
.btn-ghost{background:transparent;color:var(--slate-400);border:1px solid var(--slate-700);}
.btn-ghost:hover{color:var(--slate-200);border-color:var(--slate-500);}
.btn-gold{background:var(--gold-500);color:var(--slate-950);font-weight:600;}
.btn-gold:hover{background:var(--gold-400);}
.btn-sage{background:rgba(122,158,142,0.12);border:1px solid rgba(122,158,142,0.25);color:var(--sage-light);}
.btn-sage:hover{background:rgba(122,158,142,0.2);}

/* CONTENT */
.content{padding:32px 36px;flex:1;}

/* WELCOME BANNER */
.welcome-banner{background:linear-gradient(135deg,rgba(212,168,83,0.06),rgba(122,158,142,0.04));border:1px solid rgba(212,168,83,0.14);border-radius:6px;padding:22px 28px;margin-bottom:26px;display:flex;align-items:center;justify-content:space-between;gap:20px;}
.wb-greeting{font-size:1.5rem;font-weight:300;color:var(--slate-200);margin-bottom:4px;}
.wb-greeting em{font-style:italic;color:var(--gold-300);}
.wb-sub{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.12em;color:var(--slate-500);}
.wb-right{display:flex;gap:10px;flex-shrink:0;}

/* STAT GRID */
.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:26px;}
.stat-card{background:var(--slate-900);border:1px solid rgba(212,168,83,0.1);border-radius:6px;padding:22px 24px;position:relative;overflow:hidden;transition:border-color 0.2s;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent,var(--gold-500));opacity:0.55;}
.stat-card:hover{border-color:rgba(212,168,83,0.22);}
.stat-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.18em;text-transform:uppercase;color:var(--slate-400);margin-bottom:10px;}
.stat-value{font-family:'Cormorant Garamond',serif;font-size:42px;font-weight:300;color:var(--slate-100);line-height:1;margin-bottom:8px;}
.stat-sub{font-size:12px;color:var(--slate-500);}

/* DASH GRID */
.dash-grid{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-bottom:20px;}
.bottom-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;}

/* PANEL */
.panel{background:var(--slate-900);border:1px solid rgba(212,168,83,0.1);border-radius:6px;overflow:hidden;}
.panel-header{display:flex;align-items:center;justify-content:space-between;padding:18px 24px;border-bottom:1px solid rgba(212,168,83,0.07);}
.panel-eyebrow{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.18em;text-transform:uppercase;color:var(--gold-400);margin-bottom:3px;}
.panel-title{font-size:16px;font-weight:400;color:var(--slate-200);}
.panel-body{padding:20px 24px;}

/* ESTATE LIST */
.estate-row{display:flex;align-items:center;gap:14px;padding:13px 24px;border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.15s;text-decoration:none;}
.estate-row:hover{background:rgba(212,168,83,0.04);}
.estate-row:last-child{border-bottom:none;}
.estate-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.dot-active{background:var(--sage-light);box-shadow:0 0 5px var(--sage-light);}
.dot-pending{background:#fbbf24;}
.dot-closed{background:var(--slate-600);}
.estate-name{flex:1;font-size:14px;color:var(--slate-200);}
.estate-file{font-family:'DM Mono',monospace;font-size:10px;color:var(--gold-400);}
.estate-date{font-family:'DM Mono',monospace;font-size:10px;color:var(--slate-600);flex-shrink:0;}

/* EMPTY STATE */
.empty-state{text-align:center;padding:48px 20px;}
.empty-icon{font-size:32px;margin-bottom:12px;opacity:0.3;}
.empty-title{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.15em;text-transform:uppercase;color:var(--slate-600);margin-bottom:8px;}
.empty-sub{font-size:13px;color:var(--slate-700);max-width:280px;margin:0 auto 20px;line-height:1.6;}

/* QUICK ACTIONS */
.action-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.action-card{background:rgba(255,255,255,0.02);border:1px solid rgba(212,168,83,0.08);border-radius:5px;padding:16px 14px;cursor:pointer;transition:all 0.2s;text-decoration:none;display:flex;flex-direction:column;gap:8px;}
.action-card:hover{border-color:rgba(212,168,83,0.22);background:rgba(212,168,83,0.04);}
.action-icon{font-size:20px;}
.action-label{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:var(--slate-400);}
.action-desc{font-size:12px;color:var(--slate-600);line-height:1.4;}

/* SETUP CHECKLIST */
.setup-list{display:flex;flex-direction:column;gap:8px;}
.setup-item{display:flex;align-items:center;gap:12px;padding:11px 14px;border-radius:4px;border:1px solid rgba(255,255,255,0.05);background:rgba(255,255,255,0.015);font-size:13px;cursor:pointer;transition:all 0.2s;text-decoration:none;color:var(--slate-300);}
.setup-item:hover{border-color:rgba(212,168,83,0.2);}
.setup-item.done{opacity:0.4;}
.setup-check{width:20px;height:20px;border-radius:50%;border:1px solid rgba(212,168,83,0.3);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:10px;font-family:'DM Mono',monospace;color:var(--slate-600);}
.setup-check.checked{background:rgba(45,106,79,0.25);border-color:var(--sage);color:var(--sage-light);}
.setup-label{flex:1;}
.setup-arrow{color:var(--slate-600);font-size:12px;}

/* AUDIT LOG */
.log-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:12.5px;align-items:flex-start;}
.log-item:last-child{border-bottom:none;}
.log-time{font-family:'DM Mono',monospace;font-size:10px;color:var(--slate-600);width:54px;flex-shrink:0;padding-top:2px;}
.log-event{color:var(--slate-300);line-height:1.5;}

/* SECURITY STATUS */
.sec-row{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-radius:4px;margin-bottom:8px;}
.sec-row:last-child{margin-bottom:0;}
.sec-active{background:rgba(45,106,79,0.08);border:1px solid rgba(45,106,79,0.2);}
.sec-inactive{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);}
.sec-label{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--slate-200);}
.sec-inactive .sec-label{color:var(--slate-400);}
.sec-badge-on{font-family:'DM Mono',monospace;font-size:10px;color:var(--sage-light);}
.sec-badge-off{font-family:'DM Mono',monospace;font-size:10px;color:var(--slate-600);}

/* TOAST */
.toast{position:fixed;bottom:32px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--slate-800);border:1px solid rgba(212,168,83,0.2);color:var(--slate-200);padding:12px 22px;border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.06em;opacity:0;transition:opacity 0.3s,transform 0.3s;pointer-events:none;z-index:9999;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="logo">
    <div class="logo-mark">
      <div class="logo-shield">ğŸ›¡</div>
      <span class="logo-name">AfterGuard</span>
    </div>
    <div class="logo-tagline">Secure Portal</div>
  </div>
  <nav class="nav">
    <div class="nav-section-label">Monitor</div>
    <a href="vigil-security.html" class="nav-item active"><span class="nav-icon">ğŸ </span>Overview</a>
    <div class="nav-section-label">Security</div>
    <a href="alerts.html" class="nav-item"><span class="nav-icon">ğŸ””</span>Alerts</a>
    <a href="threats.html" class="nav-item"><span class="nav-icon">âš¡</span>Threats</a>
    <a href="threat-intel.html" class="nav-item"><span class="nav-icon">ğŸ”</span>Threat Intel</a>
    <div class="nav-section-label">Access</div>
    <a href="access-control.html" class="nav-item"><span class="nav-icon">ğŸ”</span>Access Control</a>
    <div class="nav-section-label">Records</div>
    <a href="estate-records.html" class="nav-item"><span class="nav-icon">ğŸ“‚</span>Estate Records</a>
    <a href="family-portals.html" class="nav-item"><span class="nav-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span>Family Portals</a>
    <div class="nav-section-label">Compliance</div>
    <a href="audit-log.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span>Audit Log</a>
    <a href="staff-roles.html" class="nav-item"><span class="nav-icon">ğŸ‘¥</span>Staff & Roles</a>
  </nav>
  <div class="sidebar-footer">
    <div class="user-card">
      <div class="user-avatar" id="sidebar-avatar">?</div>
      <div class="user-info">
        <div class="user-name" id="sidebar-name">Loadingâ€¦</div>
        <div class="user-role" id="sidebar-role">Member</div>
      </div>
    </div>
    <button class="signout-btn" onclick="handleSignOut()">â†’ Sign Out</button>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div>
      <div class="page-eyebrow">Security Overview</div>
      <div class="page-title" id="topbar-title">Dashboard</div>
    </div>
    <div class="topbar-right">
      <span class="live-dot"></span>
      <span class="live-label">LIVE Â· ENCRYPTED</span>
      <a href="estate-records.html" class="btn btn-gold">+ New Estate</a>
    </div>
  </div>

  <div class="content">

    <!-- WELCOME BANNER -->
    <div class="welcome-banner">
      <div>
        <div class="wb-greeting">Welcome back, <em id="wb-name">â€¦</em></div>
        <div class="wb-sub" id="wb-sub">Loading your portalâ€¦</div>
      </div>
      <div class="wb-right">
        <a href="estate-records.html" class="btn btn-ghost">View All Estates</a>
        <a href="family-portals.html" class="btn btn-sage">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Family Portals</a>
      </div>
    </div>

    <!-- STATS -->
    <div class="stat-grid">
      <div class="stat-card" style="--accent:var(--gold-500)">
        <div class="stat-label">Active Estates</div>
        <div class="stat-value" id="s-estates">0</div>
        <div class="stat-sub" id="s-estates-sub">No portals yet</div>
      </div>
      <div class="stat-card" style="--accent:#5b9bd5">
        <div class="stat-label">Documents Stored</div>
        <div class="stat-value" id="s-docs">0</div>
        <div class="stat-sub">AES-256 encrypted</div>
      </div>
      <div class="stat-card" style="--accent:var(--sage)">
        <div class="stat-label">Family Members</div>
        <div class="stat-value" id="s-members">0</div>
        <div class="stat-sub">With portal access</div>
      </div>
      <div class="stat-card" style="--accent:var(--gold-300)">
        <div class="stat-label">Audit Events</div>
        <div class="stat-value" id="s-audit">0</div>
        <div class="stat-sub">Actions logged</div>
      </div>
    </div>

    <!-- MAIN GRID -->
    <div class="dash-grid">

      <!-- ESTATE LIST PANEL -->
      <div class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-eyebrow">Estate Portals</div>
            <div class="panel-title">Your Active Estates</div>
          </div>
          <a href="estate-records.html" class="btn btn-ghost" style="font-size:10px;padding:6px 14px">View All â†’</a>
        </div>
        <div id="estate-list-wrap">
          <div class="empty-state">
            <div class="empty-icon">ğŸ“‚</div>
            <div class="empty-title">No estates yet</div>
            <div class="empty-sub">Create your first estate portal to get started protecting your family's records.</div>
            <a href="estate-records.html" class="btn btn-gold" style="display:inline-flex">+ Create First Estate</a>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div style="display:flex;flex-direction:column;gap:20px;">

        <!-- QUICK ACTIONS -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Quick Actions</div>
          </div>
          <div class="panel-body">
            <div class="action-grid">
              <a href="estate-records.html" class="action-card">
                <div class="action-icon">ğŸ“‚</div>
                <div class="action-label">New Estate</div>
                <div class="action-desc">Create a secure estate portal</div>
              </a>
              <a href="family-portals.html" class="action-card">
                <div class="action-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
                <div class="action-label">Invite Family</div>
                <div class="action-desc">Grant access to family members</div>
              </a>
              <a href="estate-records.html" class="action-card">
                <div class="action-icon">ğŸ”’</div>
                <div class="action-label">Upload Docs</div>
                <div class="action-desc">Add files to the vault</div>
              </a>
              <a href="audit-log.html" class="action-card">
                <div class="action-icon">ğŸ“‹</div>
                <div class="action-label">Audit Log</div>
                <div class="action-desc">Review activity history</div>
              </a>
            </div>
          </div>
        </div>

        <!-- SETUP CHECKLIST -->
        <div class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-eyebrow">Getting Started</div>
              <div class="panel-title">Setup Checklist</div>
            </div>
          </div>
          <div class="panel-body">
            <div class="setup-list">
              <div class="setup-item done">
                <div class="setup-check checked">âœ“</div>
                <div class="setup-label">Create your account</div>
              </div>
              <a href="estate-records.html" class="setup-item" id="check-estate">
                <div class="setup-check" id="chk-estate">1</div>
                <div class="setup-label">Create your first estate portal</div>
                <div class="setup-arrow">â†’</div>
              </a>
              <a href="estate-records.html" class="setup-item" id="check-doc">
                <div class="setup-check" id="chk-doc">2</div>
                <div class="setup-label">Upload a document to the vault</div>
                <div class="setup-arrow">â†’</div>
              </a>
              <a href="family-portals.html" class="setup-item" id="check-family">
                <div class="setup-check" id="chk-family">3</div>
                <div class="setup-label">Invite a family member</div>
                <div class="setup-arrow">â†’</div>
              </a>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- BOTTOM GRID -->
    <div class="bottom-grid">

      <!-- AUDIT LOG -->
      <div class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-eyebrow">Compliance</div>
            <div class="panel-title">Recent Activity</div>
          </div>
          <a href="audit-log.html" class="btn btn-ghost" style="font-size:10px;padding:6px 14px">Full Log â†’</a>
        </div>
        <div class="panel-body" style="padding-top:12px;">
          <div id="audit-log-wrap">
            <div class="empty-state" style="padding:28px">
              <div class="empty-icon">ğŸ“‹</div>
              <div class="empty-title">No activity yet</div>
              <div class="empty-sub">Actions you take will appear here</div>
            </div>
          </div>
        </div>
      </div>

      <!-- SECURITY STATUS -->
      <div class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-eyebrow">Security Status</div>
            <div class="panel-title">Portal Protection</div>
          </div>
        </div>
        <div class="panel-body">
          <div class="sec-row sec-active">
            <div class="sec-label"><span>ğŸ”’</span> AES-256 Encryption</div>
            <span class="sec-badge-on">ACTIVE</span>
          </div>
          <div class="sec-row sec-active">
            <div class="sec-label"><span>ğŸ›¡</span> HIPAA-Aligned Storage</div>
            <span class="sec-badge-on">ACTIVE</span>
          </div>
          <div class="sec-row sec-active">
            <div class="sec-label"><span>âœ‰ï¸</span> Email Verified</div>
            <span class="sec-badge-on">ACTIVE</span>
          </div>
          <div class="sec-row sec-inactive">
            <div class="sec-label"><span>ğŸ“±</span> Two-Factor Auth (2FA)</div>
            <span class="sec-badge-off">NOT SET</span>
          </div>
          <div class="sec-row sec-inactive" id="fh-row">
            <div class="sec-label"><span>ğŸ›ï¸</span> Funeral Home Linked</div>
            <span class="sec-badge-off" id="fh-status">LOADINGâ€¦</span>
          </div>
          <div style="margin-top:16px;padding-top:14px;border-top:1px solid rgba(255,255,255,0.05);">
            <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:0.15em;text-transform:uppercase;color:var(--slate-600);margin-bottom:10px;">Account Info</div>
            <div style="font-size:13px;color:var(--slate-400);line-height:2;">
              Email: <span style="color:var(--slate-300)" id="account-email">â€”</span><br>
              Role: <span style="color:var(--gold-300)" id="account-role">â€”</span><br>
              Member Since: <span style="color:var(--slate-300)" id="account-since">â€”</span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const SUPABASE_URL = 'https://bzscltliqeijqskcdajp.supabase.co';
const SUPABASE_KEY = 'sb_publishable_LFfDCNnaH2PDo0auIBn9oA_td5dL5bD';

const roleMap = {
  funeral_home: 'Funeral Home',
  family:       'Family Member',
  attorney:     'Attorney',
  admin:        'Administrator'
};

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', async () => {
  const { createClient } = supabase;
  const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

  // Refresh session to make sure token is current
  await sb.auth.refreshSession();
  const { data: { session }, error: sessionError } = await sb.auth.getSession();

  if (!session) {
    window.location.replace('afterguard-auth.html');
    return;
  }

  window._sb   = sb;
  window._user = session.user;

  const m    = session.user.user_metadata || {};
  const fn   = m.first_name || '';
  const ln   = m.last_name  || '';
  const full = (fn + ' ' + ln).trim() || session.user.email.split('@')[0];
  const ini  = ((fn[0]||'') + (ln[0]||'')).toUpperCase() || session.user.email[0].toUpperCase();
  const role = roleMap[m.account_type] || (m.account_type
    ? m.account_type.charAt(0).toUpperCase() + m.account_type.slice(1)
    : 'Member');

  // Populate sidebar user card
  document.getElementById('sidebar-avatar').textContent = ini;
  document.getElementById('sidebar-name').textContent   = full;
  document.getElementById('sidebar-role').textContent   = role;

  // Topbar title = org name or full name
  document.getElementById('topbar-title').textContent = m.organization || full;

  // Welcome banner name
  document.getElementById('wb-name').textContent = fn || full;

  // Account info
  document.getElementById('account-email').textContent = session.user.email;
  document.getElementById('account-role').textContent  = role;
  document.getElementById('account-since').textContent =
    new Date(session.user.created_at).toLocaleDateString('en-US',{month:'long',year:'numeric'});

  // Load dashboard data
  await loadDashboard(sb, session.user);
});

// â”€â”€ LOAD DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard(sb, user) {
  // â”€â”€ 1. ESTATES â”€â”€
  const { data: estates, error: estErr } = await sb
    .from('estates')
    .select('*')
    .eq('owner_id', user.id)
    .order('created_at', { ascending: false });

  if (estErr) {
    console.error('Estates error:', estErr.message);
    showEstateError(estErr.message);
    return;
  }

  const list = estates || [];
  document.getElementById('s-estates').textContent = list.length;
  document.getElementById('s-estates-sub').textContent =
    list.length === 0 ? 'No portals yet' :
    list.length === 1 ? '1 active portal' : `${list.length} active portals`;
  document.getElementById('wb-sub').textContent = list.length === 0
    ? 'Your portal is ready â€” create your first estate to begin'
    : `You have ${list.length} estate portal${list.length > 1 ? 's' : ''} Â· Last active today`;

  // Render estate list
  renderEstates(list);

  // Funeral home status
  const hasFH = list.some(e => e.funeral_home && e.funeral_home.trim() !== '');
  const fhEl  = document.getElementById('fh-status');
  const fhRow = document.getElementById('fh-row');
  fhEl.textContent = hasFH ? 'CONNECTED' : 'NOT LINKED';
  fhEl.className   = hasFH ? 'sec-badge-on' : 'sec-badge-off';
  if (hasFH) { fhRow.className = 'sec-row sec-active'; }

  // Checklist step 1
  if (list.length > 0) markCheck('chk-estate', 'check-estate');

  // â”€â”€ 2. DOCUMENTS â”€â”€
  if (list.length > 0) {
    const ids = list.map(e => e.id);

    const { count: docCount } = await sb
      .from('documents')
      .select('id', { count: 'exact', head: true })
      .in('estate_id', ids);

    document.getElementById('s-docs').textContent = docCount || 0;
    if (docCount > 0) markCheck('chk-doc', 'check-doc');

    // â”€â”€ 3. MEMBERS â”€â”€
    const { count: memCount } = await sb
      .from('estate_members')
      .select('id', { count: 'exact', head: true })
      .in('estate_id', ids);

    document.getElementById('s-members').textContent = memCount || 0;
    if (memCount > 0) markCheck('chk-family', 'check-family');
  }

  // â”€â”€ 4. AUDIT EVENTS â”€â”€
  const { data: auditRows } = await sb
    .from('audit_events')
    .select('*')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false })
    .limit(8);

  document.getElementById('s-audit').textContent = auditRows ? auditRows.length : 0;
  renderAuditLog(auditRows || []);
}

// â”€â”€ RENDER ESTATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEstates(list) {
  const wrap = document.getElementById('estate-list-wrap');
  if (list.length === 0) {
    wrap.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ“‚</div>
        <div class="empty-title">No estates yet</div>
        <div class="empty-sub">Create your first estate portal to start protecting records.</div>
        <a href="estate-records.html" class="btn btn-gold" style="display:inline-flex">+ Create First Estate</a>
      </div>`;
    return;
  }

  const rows = list.slice(0, 7).map(e => {
    const dot     = e.status === 'active' ? 'dot-active' : e.status === 'pending' ? 'dot-pending' : 'dot-closed';
    const created = new Date(e.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    return `<a href="estate-records.html" class="estate-row">
      <div class="estate-dot ${dot}"></div>
      <div class="estate-name">${esc(e.deceased_name || 'â€”')}</div>
      <div class="estate-file">${esc(e.file_number || '')}</div>
      <div class="estate-date">${created}</div>
    </a>`;
  }).join('');

  const more = list.length > 7
    ? `<div style="padding:12px 24px;font-family:'DM Mono',monospace;font-size:10px;color:var(--slate-600);text-align:center;">
        + ${list.length - 7} more Â· <a href="estate-records.html" style="color:var(--gold-400)">View All</a>
       </div>`
    : '';

  wrap.innerHTML = rows + more;
}

// â”€â”€ RENDER AUDIT LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAuditLog(rows) {
  const wrap = document.getElementById('audit-log-wrap');
  if (rows.length === 0) {
    wrap.innerHTML = `
      <div class="empty-state" style="padding:28px">
        <div class="empty-icon">ğŸ“‹</div>
        <div class="empty-title">No activity yet</div>
        <div class="empty-sub">Actions you take will appear here automatically</div>
      </div>`;
    return;
  }
  wrap.innerHTML = rows.map(a => {
    const t   = new Date(a.created_at);
    const str = t.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    return `<div class="log-item">
      <div class="log-time">${str}</div>
      <div class="log-event">${esc(a.event || '')}</div>
    </div>`;
  }).join('');
}

// â”€â”€ ESTATE LOAD ERROR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showEstateError(msg) {
  document.getElementById('estate-list-wrap').innerHTML = `
    <div class="empty-state">
      <div class="empty-icon">âš ï¸</div>
      <div class="empty-title">Could not load estates</div>
      <div class="empty-sub" style="color:#ef9a9a;font-family:'DM Mono',monospace;font-size:10px;">${esc(msg)}</div>
      <button class="btn btn-ghost" onclick="location.reload()" style="margin-top:8px">Retry</button>
    </div>`;
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function markCheck(checkId, itemId) {
  const chk  = document.getElementById(checkId);
  const item = document.getElementById(itemId);
  if (chk)  { chk.textContent = 'âœ“'; chk.classList.add('checked'); }
  if (item) { item.classList.add('done'); }
}

function esc(s) {
  return (s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

async function handleSignOut() {
  if (window._sb) await window._sb.auth.signOut();
  window.location.replace('afterguard-auth.html');
}
</script>
</body>
</html>
